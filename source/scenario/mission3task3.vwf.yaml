# Copyright 2014 Lockheed Martin Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may 
# not use this file except in compliance with the License. You may obtain 
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software 
# distributed under the License is distributed on an "AS IS" BASIS, 
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and 
# limitations under the License.

---
extends: ../scenario/scenario.vwf
properties:
  scenarioName: Mission3Task3

  scenePath: /
  nextScenarioPath: "Mission3Task4"

  startState:
  # objective
  - setObjective:
    - "Edit your navigate procedure: Only turn South if you need to in order to move to [0,-3]."

  # sounds/video
  - playSound:
    - musicStandardGameplay
  - playSound:
    - environmentWind
  - setProperty:
    - videoManager  
    - url 
    - [ "assets/video/Success3.mp4" ]

  #blockly
  - setBlocklyContext:
    - rover
  - setProperty:
    - rover
    - startXML
    - <xml><block type="procedures_defnoreturn" movable="false" deletable="false" editable="false" id="a" x="0" y="-260"><mutation><arg name="y-coordinate"></arg></mutation><field name="NAME">navigate</field><statement name="STACK"><block type="controls_whileUntil" id="b" inline="false"><value name="BOOL"><block type="controls_sensor_heading" id="c" inline="false"><value name="INPUT"><block type="logic_cond_out" id="d" inline="false"><field name="VALUE">!==</field><value name="INPUT"><block type="math_number_angle_select" id="e" inline="false"><field name="VALUE">270</field></block></value></block></value></block></value><statement name="DO"><block type="rover_turn" id="f"></block></statement><next><block type="controls_whileUntil" id=g"" inline="false"><value name="BOOL"><block type="variables_get" id="h" inline="false"><field name="VAR">y-coordinate</field><value name="INPUT"><block type="logic_cond_out" id="i" inline="false"><field name="VALUE">&lt;</field><value name="INPUT"><block type="controls_sensor_position_y" id="j" inline="false"></block></value></block></value></block></value><statement name="DO"><block type="rover_moveForward" id="k"></block></statement></block></next></block></statement></block><block type="controls_whileUntil_no_in" id="l" inline="false" movable="false" deletable="false" editable="false" x="0" y="-420"><value name="BOOL"><block type="controls_sensor_heading" id="m" inline="false" deletable="false" movable="false" editable="false"><value name="INPUT"><block type="logic_cond_out" id="n" deletable="false" movable="false" editable="false" inline="false"><field name="VALUE">===</field><value name="INPUT"><block type="math_number_angle_select_no_out" id="o" inline="false" deletable="false" movable="false" editable="false"><field name="VALUE">270</field></block></value></block></value></block></value><statement name="DO"><block type="rover_turn_no_out" id="p" deletable="false" movable="false" editable="false"></block></statement><next><block type="procedures_callnoreturn_no_out" id="q" deletable="false" movable="false" editable="false" inline="false"><mutation name="navigate"><arg name="y-coordinate"></arg></mutation><value name="ARG0"><block type="graph_subtract" id="s" inline="false"><value name="INPUT"><block type="math_number_field_no_out" id="r" deletable="false" movable="false" editable="false" inline="false"><field name="VALUE">3</field></block></value></block></value></block></next></block></xml>
  - setProperty:
    - rover
    - blockly_xml
    - <xml><block type="procedures_defnoreturn" movable="false" deletable="false" editable="false" id="a" x="0" y="-260"><mutation><arg name="y-coordinate"></arg></mutation><field name="NAME">navigate</field><statement name="STACK"><block type="controls_whileUntil" id="b" inline="false"><value name="BOOL"><block type="controls_sensor_heading" id="c" inline="false"><value name="INPUT"><block type="logic_cond_out" id="d" inline="false"><field name="VALUE">!==</field><value name="INPUT"><block type="math_number_angle_select" id="e" inline="false"><field name="VALUE">270</field></block></value></block></value></block></value><statement name="DO"><block type="rover_turn" id="f"></block></statement><next><block type="controls_whileUntil" id=g"" inline="false"><value name="BOOL"><block type="variables_get" id="h" inline="false"><field name="VAR">y-coordinate</field><value name="INPUT"><block type="logic_cond_out" id="i" inline="false"><field name="VALUE">&lt;</field><value name="INPUT"><block type="controls_sensor_position_y" id="j" inline="false"></block></value></block></value></block></value><statement name="DO"><block type="rover_moveForward" id="k"></block></statement></block></next></block></statement></block><block type="controls_whileUntil_no_in" id="l" inline="false" movable="false" deletable="false" editable="false" x="0" y="-420"><value name="BOOL"><block type="controls_sensor_heading" id="m" inline="false" deletable="false" movable="false" editable="false"><value name="INPUT"><block type="logic_cond_out" id="n" deletable="false" movable="false" editable="false" inline="false"><field name="VALUE">===</field><value name="INPUT"><block type="math_number_angle_select_no_out" id="o" inline="false" deletable="false" movable="false" editable="false"><field name="VALUE">270</field></block></value></block></value></block></value><statement name="DO"><block type="rover_turn_no_out" id="p" deletable="false" movable="false" editable="false"></block></statement><next><block type="procedures_callnoreturn_no_out" id="q" deletable="false" movable="false" editable="false" inline="false"><mutation name="navigate"><arg name="y-coordinate"></arg></mutation><value name="ARG0"><block type="graph_subtract" id="s" inline="false"><value name="INPUT"><block type="math_number_field_no_out" id="r" deletable="false" movable="false" editable="false" inline="false"><field name="VALUE">3</field></block></value></block></value></block></next></block></xml>
  - loadToolbox:
    - rover
    - source/scenario/blockly/mission3c.xml
  - delay:
    - .5  
    - callMethod:
      - rover
      - resetSensors

  #Manny
  - addToGrid:
    - rover
    - [ -17, 26 ]
  - selectRover:
    - rover
  - callMethod:
    - rover
    - setHeading
    - 180
  - setProperty:
    - rover
    - battery
    - 40
  - setProperty:
    - rover
    - batteryMax
    - 40
  - setProperty:
    - rover
    - blockly_allowedBlocks
    - 70

  # Perry, Rosie disabled
  - setProperty:
    - rover2
    - visible
    - false
  
  - setProperty:
    - minirover
    - visible
    - false

  # Disable Blockly line
  - setProperty:
    - blocklyLine
    - visible
    - false
  - setProperty:
    - blocklyLine
    - opacity
    - 0

  # Graph

  - addToGrid:
    - blocklyGraph
    - [ -17, 32 ]
  - setGridAxes:
    - 32
    - -17
  
  - setProperty:
    - cargoPod2
    - isClosed
    - true

  - setProperty:
    - roverTracks2
    - visible
    - true

  # turning supplies and minirover invisible

  - setProperty:
    - supplies_1
    - visible
    - false
  - setProperty:
    - supplies_2
    - visible
    - false
  - setProperty:
    - minirover
    - visible
    - false

children:
  triggerManager:
    extends: ../triggers/triggerManager.vwf
    properties: 
      triggers$:
        playStartingVO_3d:
          triggerCondition:
          - and:
            - doOnce:
            - onScenarioStart:
          actions:
          - playSound:
            - TM3VO7_Rover
          - playSound:
            - m3t3vo010
          - playSound:
            - m3t3vo020
          - playSound:
            - m3t3vo030
          - setProperty:
            - hud
            - enabled
            - false
          - delay:
            - 19
            - openMissionBrief:
            - setProperty:
              - hud
              - enabled
              - true

        highlightEndTile_3_3:
          triggerCondition:
          - onScenarioStart:
          actions:
          - callOutObjective:
            - [ 0, -6 ]

        failOnMissingBlock_3_3:
          group: successOrFailure
          priority: 0.5
          triggerCondition:
          - and:
            - onBlocklyStopped:
              - rover
            - hasHeading:
              - rover
              - 270
            - isAtPosition:
              - rover
              - [-17, 26]
            - isBlockMissing:
              - controls_if_nomut
          actions:
          - scenarioFailure:
            - incomplete
            - "You should use the if block."
          - playSound:
            - FCVO2_Rover

        succeedOnSuccessfulMovement_3_3:
          group: successOrFailure
          priority: 0
          triggerCondition:
          - and:
            - onBlocklyStopped:
              - rover
            - hasHeading:
              - rover
              - 270
            - isAtPosition:
              - rover
              - [-17, 26]

          actions:
          - clearBlockly:
          - scenarioSuccess:
          - showAlert:
            - "Test program completed!"
          - playSound:
            - musicSuccessShort

        playHint_M3T3:
          triggerCondition:
          - and:
            - doOnce:
            - delay:
              - 30
          actions:
          - playSound:
            - m3t3vo040

  brief:
    extends: ../missionBrief.vwf
    properties:
      title: "Mission 3, Task 3"
      content: >
        Good job editing your Navigation procedure!
        <br><br> Let's ensure that you don't waste energy spinning in place when
        you don't need to. You can do that by using an If block to compare
        your current position with the spot you want to move to. The If block is
        a new block that only executes its contents if its condition is true.

