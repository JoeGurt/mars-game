# Copyright 2014 Lockheed Martin Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may 
# not use this file except in compliance with the License. You may obtain 
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software 
# distributed under the License is distributed on an "AS IS" BASIS, 
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and 
# limitations under the License.

---
extends: ../scenario/scenario.vwf
properties:
  scenarioName: mission4task1
  nextScenarioPath: 'mission4task2'
  scenePath: /

  startState:

  # objective
  - setObjective:
    - "Lay down nanobuilders in a triangle with vertices at (-10,0), (-10,3), and (-13,0)."

  # sound/video

  - playSound:
    - musicMission4Intro
  - playSound:
    - musicMission4Loop_AfterIntro
  - playSound:
    - environmentWind
  - setProperty:
    - videoManager  
    - url 
    - [ "assets/video/end_cinematic.webm", "assets/video/end_cinematic.mp4" ]

  # blockly
  - enableBlocklyNodes:
    - rover
    - rover2
  - loadToolbox:
    - rover
    - source/scenario/blockly/mission4.xml
  - loadToolbox:
    - rover2
    - source/scenario/blockly/mission4_perry.xml
  - setProperty:
    - rover2
    - blockly_xml
    - <xml><block deletable="false" movable="false" editable="false" type="variables_set" id="137" inline="true" x="60" y="0"><field name="VAR">vertex1</field><value name="VALUE"><block deletable="false" movable="false" editable="false" type="ordered_pair_config" id="80" inline="true"><value name="XFIELD"></value><value name="YFIELD"></value></block></value><next><block deletable="false" movable="false" editable="false" type="variables_set" id="173" inline="true"><field name="VAR">vertex2</field><value name="VALUE"><block deletable="false" movable="false" editable="false" type="ordered_pair_config" id="81" inline="true"><value name="XFIELD"></value><value name="YFIELD"></value></block></value><next><block deletable="false" movable="false" editable="false" type="variables_set" id="175" inline="true"><field name="VAR">vertex3</field><value name="VALUE"><block deletable="false" movable="false" editable="false" type="ordered_pair_config" id="82" inline="true"><value name="XFIELD"></value><value name="YFIELD"></value></block></value><next><block deletable="false" movable="false" editable="false" type="rover_moveRadial_absolute" id="83" inline="true"><value name="x"><block deletable="false" movable="false" editable="false" type="variables_get" id="84" inline="false"><field name="VAR">vertex1</field><value name="INPUT"><block deletable="false" movable="false" editable="false" type="ordered_get_noin" id="85"><field name="OPTION">.x</field></block></value></block></value><value name="y"><block deletable="false" movable="false" editable="false" type="variables_get" id="86" inline="false"><field name="VAR">vertex1</field><value name="INPUT"><block deletable="false" movable="false" editable="false" type="ordered_get_noin" id="87"><field name="OPTION">.y</field></block></value></block></value><next><block deletable="false" movable="false" editable="false" type="start_triangle" id="225" ><next><block deletable="false" movable="false" editable="false" type="mark_point" id="241" ><next><block deletable="false" movable="false" editable="false" type="rover_moveRadial_absolute" id="181" inline="true"><value name="x"><block deletable="false" movable="false" editable="false" type="variables_get" id="182" inline="false"><field name="VAR">vertex2</field><value name="INPUT"><block deletable="false" movable="false" editable="false" type="ordered_get_noin" id="199" ><field name="OPTION">.x</field></block></value></block></value><value name="y"><block deletable="false" movable="false" editable="false" type="variables_get" id="200" inline="false"><field name="VAR">vertex2</field><value name="INPUT"><block deletable="false" movable="false" editable="false" type="ordered_get_noin" id="201" ><field name="OPTION">.y</field></block></value></block></value><next><block deletable="false" movable="false" editable="false" type="mark_point" id="233" ><next><block deletable="false" movable="false" editable="false" type="rover_moveRadial_absolute" id="202" inline="true"><value name="x"><block deletable="false" movable="false" editable="false" type="variables_get" id="203" inline="false"><field name="VAR">vertex3</field><value name="INPUT"><block deletable="false" movable="false" editable="false" type="ordered_get_noin" id="204" ><field name="OPTION">.x</field></block></value></block></value><value name="y"><block deletable="false" movable="false" editable="false" type="variables_get" id="205" inline="false"><field name="VAR">vertex3</field><value name="INPUT"><block deletable="false" movable="false" editable="false" type="ordered_get_noin" id="206" ><field name="OPTION">.y</field></block></value></block></value><next><block deletable="false" movable="false" editable="false" type="mark_point" id="237"><next><block deletable="false" movable="false" editable="false" type="rover_moveRadial_absolute" id="207" inline="true"><value name="x"><block deletable="false" movable="false" editable="false" type="variables_get" id="208" inline="false"><field name="VAR">vertex1</field><value name="INPUT"><block deletable="false" movable="false" editable="false" type="ordered_get_noin" id="209" ><field name="OPTION">.x</field></block></value></block></value><value name="y"><block deletable="false" movable="false" editable="false" type="variables_get" id="210" inline="false"><field name="VAR">vertex1</field><value name="INPUT"><block deletable="false" movable="false" editable="false" type="ordered_get_noin" id="211" ><field name="OPTION">.y</field></block></value></block></value><next><block deletable="false" movable="false" editable="false" type="mark_point" id="245" ><next><block deletable="false" movable="false" editable="false" type="end_triangle" id="229" ></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></xml>d></block></value></block></value><next><block deletable="false" movable="false" editable="false" type="mark_point" id="237" ><next><block deletable="false" movable="false" editable="false" type="rover_moveRadial_absolute" id="207" inline="true"><value name="x"><block deletable="false" movable="false" editable="false" type="variables_get" id="208" inline="false"><field name="VAR">vertex1</field><value name="INPUT"><block deletable="false" movable="false" editable="false" type="ordered_get_noin" id="209" ><field name="OPTION">.x</field></block></value></block></value><value name="y"><block deletable="false" movable="false" editable="false" type="variables_get" id="210" inline="false"><field name="VAR">vertex1</field><value name="INPUT"><block deletable="false" movable="false" editable="false" type="ordered_get_noin" id="211" ><field name="OPTION">.y</field></block></value></block></value><next><block deletable="false" movable="false" editable="false" type="mark_point" id="245" ><next><block deletable="false" movable="false" editable="false" type="end_triangle" id="229" ></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></xml>
  # Manny
  - addToGrid:
    - rover
    - [ -13, -11 ]
  - callMethod:
    - rover
    - setHeading
    - 270
  - setProperty:
    - rover
    - battery
    - 12
  - setProperty:
    - rover
    - batteryMax
    - 150
  - setProperty:
    - rover
    - blockly_allowedBlocks
    - 15
  - setProperty:
    - rover
    - lowRam
    - 3
  - emptyInventory:
    - rover/cargo

  # Perry
  - setProperty:
    - rover2
    - visible
    - true
  - addToGrid:
    - rover2
    - [ -10, -10 ]
  - setProperty:
    - rover2
    - battery
    - 1000
  - setProperty:
    - rover2
    - batteryMax
    - 1000
  - setProperty:
    - rover2
    - blockly_allowedBlocks
    - 50
  - setProperty:
    - rover2
    - lowRam
    - 5
  - setProperty:
    - rover3
    - visible
    - false
  - drawTriangle:
    - [ -10, 0 ]
    - [ -10, 3 ]
    - [ -13, 0 ]
  - addToGrid:
    - cargoPod2
    - [ -10, -13 ]
  - setProperty:
    - cargoPod2
    - visible
    - true
  - addToGrid:
    - solarPanel1
    - [ -10, -0 ]
  # - setProperty:
  #   - solarPanel1
  #   - visible
  #   - true
  # - setProperty:
  #   - solarPanel1
  #   - built
  #   - true

children:
  triggerManager:
    extends: ../triggers/triggerManager.vwf
    properties: 
      triggers$:
        succeedOnTriangle_4_1:
          group: successOrFailure
          priority: 0
          triggerCondition:
          - onBlocklyPolygon:
            - rover2
            - [ [ -10, 0 ], [ -10, 3 ], [ -13, 0 ] ]
          actions:
          - showAlert:
            - "I created the correct triangle!"
          - callMethod:
            - rover2
            - stopExecution
          - clearBlockly:
          - scenarioSuccess:
          - playSound:
            - musicSuccessShort
          - playSound:
            - M4VO26_MC
          - buildBaseComponent:
            - solarPanel1

        playStartingVO_4_1_1:
          triggerCondition:
          - and:
            - doOnce:
            - onScenarioStart:
          actions:
          - playSound:
            - M4VO19_MC
          - playSound:
            - M4VO20_Rover
          - playSound:
            - M4VO21_MC
          - playSound:
            - M4VO22_Rover
          - playSound:
            - PerryThanksALot
          - playSound:
            - M4VO23_MC
          - playSound:
            - M4VO24_Rover
          - playSound:
            - PerryWhatsAClown
          - playSound:
            - M4VO25_Rover

        openMissionBrief_4_1:
          triggerCondition:
          - and:
            - delay:
              - 60
            - doOnce:
          actions:
          - openMissionBrief:

        playPerrySounds_4_1_1:
          triggerCondition:
          - onBlocklyBlock:
            - rover2
            - moveRadial
            - true
          actions:
            - playSound:
              - rover2GravelSounds

        stopPerrySounds_4_1_1:
          triggerCondition:
          - onBlocklyBlock:
            - rover2
            - moveRadial
            - false
          actions:
            - stopSound:
              - rover2GravelSounds

        scenarioEnded4_1:
          triggerCondition:
          - or: 
            - onScenarioSucceeded:
            - onScenarioFailed:
          actions:
          - setProperty:
            - rover2
            - surveyArray
            - []

  brief:
    extends: ../missionBrief.vwf
    properties:
      title: "Mission 4, Task 1"
      content: >
        Congratulations! You’ve found the cargo pod! 
        <br><br>The pod you've found contains a large amount of nanites! 
        Nanites are microscopic robots that can construct materials using 
        nothing but the air and soil of Mars. The pod also contained your 
        newest rover, Peregrine, who is designed to transport the nanites 
        and place them on the ground to build the base for the humans. 
        <br><br>You seem to be running low on battery! Let's get Peregrine 
        working on building some solar panels. Your helicam will illuminate 
        a triangle on the ground where you can build a solar panel. All you 
        have to do is put in the vertices of the triangle for Peregrine to 
        follow and his built-in program will do the rest. <br><br>Remember, 
        a vertex is an ordered pair of coordinates: ( x, y ). Set the x and 
        y values in the program to match the ordered pairs in your objective 
        indicator.

  grid:
    includes: source/grid.vwf
    properties:
      minX: -17
      maxX: 27
      minY: -14
      maxY: 24
      gridOriginInSpace: [ -93, 216 ]
      gridSquareLength: 3
      boundaryValues:
      - [ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1, -1, -1, -1, -1, -1, -1, -1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1, -1, -1, -1, -1, -1, -1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1, -1, -1, -1, -1, -1 ]
      - [ -1,  1, -1, -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1, -1, -1, -1, -1 ]
      - [ -1,  1, -1, -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1, -1, -1, -1 ]
      - [ -1,  1, -1, -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1, -1, -1, -1 ]
      - [ -1,  1, -1, -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1, -1, -1, -1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1, -1, -1, -1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1, -1, -1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1, -1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1, -1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1, -1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, -1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1 ]
      - [ -1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1 ]
      - [ -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1 ]
