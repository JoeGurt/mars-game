# Copyright 2014 Lockheed Martin Corporation
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may 
# not use this file except in compliance with the License. You may obtain 
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software 
# distributed under the License is distributed on an "AS IS" BASIS, 
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and 
# limitations under the License.

---
extends: ../scenario/scenario.vwf
properties:
  scenarioName: oldmission3task1
  nextScenarioPath: mission4task1

  startState:

  # objective
  - setObjective:
    - "Use the signal sensor and the metal sensor to find the base pod."

  # sounds/music
  - playSound:
    - musicStandardGameplay
  - playSound:
    - environmentWind

  # movie preload
  # TODO: switch to the appropriate success movie
  - setProperty:
    - videoManager  
    - url 
    - [ "assets/video/end_cinematic.webm", "assets/video/end_cinematic.mp4" ]

  # blockly
  - setBlocklyContext:
    - rover
  - loadToolbox:
    - rover
    - source/scenario/blockly/mission3.xml

  # Manny
  - addToGrid:
    - rover
    - [ -41, 51 ]
  - callMethod:
    - rover
    - setHeading
    - 0
  - callMethod:
    - rover
    - resetSensors
  - setProperty:
    - rover
    - battery
    - 50
  - setProperty:
    - rover
    - batteryMax
    - 150
  - setProperty:
    - rover
    - blockly_allowedBlocks
    - 15
  - setProperty:
    - rover
    - lowRam
    - 3

  # Perry, Rosie disabled
  - setProperty:
    - rover2
    - visible
    - false
  - setProperty:
    - rover3
    - visible
    - false

  # signal & metal
  - writeToBlackboard:
    - metalPosition
    - [ -26, 75 ]
  - writeToBlackboard:
    - signalPosition
    - [ -27, 75 ]

children:
  triggerManager:
    extends: ../triggers/triggerManager.vwf
    properties: 
      triggers$:
        succeedOnSuccessfulMovement_3_1:
          group: successOrFailure
          priority: 0
          triggerCondition:
          - and:
            - onBlocklyStopped:
              - rover
            - isAtPosition:
              - rover
              - [ -27, 75 ]
          actions:
          - showAlert:
            - "I found the base pod!"
          - scenarioSuccess:
          - playSound:
            - musicSuccessShort

        scenarioEnded3_1:
          triggerCondition:
          - or: 
            - onScenarioSucceeded:
            - onScenarioFailed:
          actions:
          - clearBlackboardEntry:
            - metalPosition
          - clearBlackboardEntry:
            - signalPosition

        playStartingVO_3_1_1:
          triggerCondition:
          - and:
            - doOnce:
            - onScenarioStart:
          actions:
          - playSound:
            - M3VO1_Rover
          - playSound:
            - M3VO2_MC
          - playSound:
            - M3VO3_Rover
          - playSound:
            - M3VO4_MC
          - playSound:
            - M3VO5_Rover
          - playSound:
            - M3VO6_MC
          - playSound:
            - M3VO7_Rover
          - playSound:
            - M3VO8_MC
          - playSound:
            - M3VO9_Rover
          - playSound:
            - M3VO10_MC
          - playSound:
            - M3VO11_Rover
          - playSound:
            - M3VO12_MC

        openMissionBrief_3_1:
          triggerCondition:
          - and:
            - delay:
              - 84
            - doOnce:
          actions:
          - openMissionBrief:

  brief:
    extends: ../missionBrief.vwf
    properties:
      title: "Mission 3, Task 1"
      content: >
        Your sensors have detected that one of the 
        cargo pods has landed nearby. The exact location of the pod is 
        unknown, but your Signal Sensor will show you the angle to the pod 
        from your current position. Your rover can only face 4 directions: 
        <br><img src='assets/images/tooltips/heading.png' /><br> As you can 
        see, to the right is 0 degrees, up is 90 degrees, left is 180 degrees 
        and down is 270 degrees. <br><br>Try moving until the signal matches 
        one of those directions. Once you are facing the direction of the signal, 
        you can move forward until your Metal Detector finds the pod.
